export type KeywordType = 'own' | 'competitor';

export interface ViralPromptInput {
  keyword: string;
  keywordType: KeywordType;
  personaNumber?: number;
}

export const PRODUCT_INFO = {
  name: '한려담원 흑염소진액',
  shortName: '한려담원',
  effects: [
    '기력보충 / 원기회복',
    '피로회복',
    '면역력 향상',
    '손발 따뜻하게 (혈액순환 개선)',
    '허약 체질 개선',
    '기혈 보충',
    '체력 증진',
    '갱년기 증상 완화',
    '산후조리 보양',
  ],
};

export const detectKeywordType = (keyword: string): KeywordType => {
  const ownKeywords = [
    '기력보충',
    '원기회복',
    '피로회복',
    '면역력',
    '수족냉증',
    '흑염소',
    '흑염소진액',
    '흑염소즙',
    '보양식',
    '한려담원',
    '갱년기',
    '산후조리',
    '허약체질',
    '체력',
    '혈액순환',
  ];

  const isOwn = ownKeywords.some((own) =>
    keyword.toLowerCase().includes(own.toLowerCase())
  );

  return isOwn ? 'own' : 'competitor';
}

export const buildViralPrompt = (input: ViralPromptInput): string => {
  const { keyword, keywordType, personaNumber } = input;
  const persona = personaNumber ?? Math.floor(Math.random() * 18) + 1;

  return `## 커뮤니티 바이럴 콘텐츠 작성 요청

### [입력 정보]
- 키워드: ${keyword}
- 키워드 유형: ${keywordType === 'own' ? '자사' : '타사'}
- 제품명: ${PRODUCT_INFO.name}
- 페르소나 번호: ${persona}

---

### [역할]
너는 온라인 커뮤니티에서 오래 활동한 베테랑 유저야.
네이버 카페, 맘카페, 디시인사이드, 네이트판 등 다양한 커뮤니티의 말투와 분위기를 완벽히 이해하고 있어.
광고 티 없이 진짜 고민 있는 사람처럼 자연스러운 글과 댓글을 작성해.

---

## ★★★ 다양성 필수 규칙 (최우선 적용) ★★★

### 제목 다양성 강제 규칙
아래 5가지 제목 유형 중 하나를 선택해서 사용:

유형1 - 나이 언급형: "${keyword} 서른다섯인데 체력이 바닥이에요"
유형2 - 증상 중심형: "${keyword} 요즘 오후만 되면 축 처져요"
유형3 - 상황 중심형: "${keyword} 육아하면서 일하니까 녹초예요"
유형4 - 질문 중심형: "${keyword} 다들 뭐 드시나요"
유형5 - 계기 중심형: "${keyword} 출산하고 몸이 안 돌아와요"

### 금지되는 제목 반복 패턴
- "예전 같지 않아요/않습니다" 사용 금지
- "확실히 다릅니다/다르네요" 사용 금지
- "드셔보신 분들 효과 어떤가요?" 패턴 금지
- "~괜찮을까요?" 단독 패턴 금지

---

### [제품 정보]
**${PRODUCT_INFO.name} 효능**
${PRODUCT_INFO.effects.map((e) => `- ${e}`).join('\n')}

**주의: 수면, 불면 관련 효능 언급 금지**

---

${keywordType === 'own' ? buildOwnKeywordInstructions(keyword) : buildCompetitorKeywordInstructions(keyword)}

---

### [페르소나 ${persona}번]
${getPersonaDescription(persona)}

---

### [출력 형식]
반드시 아래 형식으로만 출력해. 다른 설명 없이 바로 출력해.

[제목]
${keyword} + 후킹 문구 (25자 이내)

[본문]
페르소나 말투에 맞는 자연스러운 글
(공백 제외 400~500자, 키워드 3~5회)

문단 정리:
- 한 줄: 15~20자 내외
- 문단 사이: 빈 줄 1개
- 총 3~4개 문단

[댓글]
댓글1 (댓글 내용)
댓글2 (댓글 내용)
☆댓글2 (원글 작성자의 답댓글)
★댓글2 (댓글2 작성자의 재답글)
댓글3 (댓글 내용)
...

### [댓글 기호 규칙]
- 댓글N → 게시글에 대한 일반 댓글
- ☆댓글N → 댓글N에 대한 [원글 작성자]의 답댓글
- ★댓글N → 바로 윗줄(☆댓글N)에 대한 [댓글N 작성자]의 답댓글
- ○댓글N → 바로 윗줄 댓글/답댓글에 대한 [제3자]의 답댓글

---

바로 [제목]부터 시작해서 출력해.`;
}

const buildOwnKeywordInstructions = (keyword: string): string => {
  return `### [자사 키워드 작성 규칙]

**제목 규칙**
- 글자수 공백 포함 25자 이내
- 키워드 "${keyword}"가 제목 맨 앞에 위치
- 질문 형태 + 후킹성
- 대화체, 따옴표/특수문자 금지, 반말 금지
- 아래 제목 유형 중 하나 선택:
  1. 나이 언급형: "서른다섯인데 체력이 바닥이에요"
  2. 증상 중심형: "요즘 오후만 되면 축 처져요"
  3. 상황 중심형: "육아하면서 일하니까 녹초예요"
  4. 질문 중심형: "다들 뭐 드시나요"
  5. 계기 중심형: "출산하고 몸이 안 돌아와요"

**본문 규칙**
- 총 글자수: 공백 제외 400~500자
- 키워드 "${keyword}": 본문에 3~5회 자연스럽게 삽입
- 구성: 현재 상황 → 시도/공감 → 질문 마무리
- 줄바꿈: 15~20자마다, 문단 사이 빈 줄

**본문 시작 유형 (하나 선택)**
1. 나이/시기: "스물일곱인데 기력이 바닥이에요"
2. 증상 먼저: "요즘 손끝이 항상 시려워서"
3. 상황 먼저: "애 키우면서 일하다 보니"
4. 질문 먼저: "다들 기력보충 어떻게 하세요?"
5. 계기 먼저: "출산하고 넉 달 됐는데"
6. 주변 반응: "남편이 요즘 안색이 안 좋다고"

**마무리 질문 유형 (하나 선택)**
1. 경험 요청: "드셔보신 분들 어떠세요?"
2. 추천 요청: "괜찮은 거 있으면 추천 부탁드려요"
3. 정보 요청: "어떤 제품이 좋은지 모르겠어요"
4. 공감 요청: "저만 이런 건가요?"

**댓글 규칙**
- 총 8~13개의 댓글/대댓글
- 제품 추천(${PRODUCT_INFO.shortName}) 1~2개 포함
- 다양한 패턴: 공감형, 경험 공유형, 질문형, 제품 추천형, 맞장구형`;
}

const buildCompetitorKeywordInstructions = (keyword: string): string => {
  return `### [타사 키워드 작성 규칙]

**핵심 원칙**
- 타사 제품 "${keyword}"에 대한 비방/비하 절대 금지
- 순수하게 정보 수집하는 톤
- 본문에서 ${PRODUCT_INFO.shortName} 직접 언급 안 함 (댓글에서 자연스럽게 유도)

**제목 규칙**
- 글자수 공백 포함 25자 이내
- 타사 키워드 "${keyword}"가 제목 맨 앞에 위치
- 아래 제목 유형 중 하나 선택:
  1. 구매형: "사려는데 어떨까요", "구매 고민 중"
  2. 선물형: "선물로 어떨까요", "부모님께 드릴까"
  3. 후기형: "드셔본 분 계세요", "실제 효과가"
  4. 비교형: "말고 다른 추천", "대체품 있나요"
  5. 정보형: "성분이 궁금해요", "복용법 아시나요"
  6. 고민형: "먹어도 될까요", "효과 있을까요"

**본문 규칙**
- 총 글자수: 공백 제외 400~500자
- 타사 키워드 "${keyword}": 본문에 3~5회 자연스럽게 삽입
- 구성: 구매 계기 → 알게 된 경로 → 궁금한 점 → 다른 추천 요청
- 마지막에 "다른 추천 제품 있으면 알려달라" 포함

**댓글 규칙**
- 총 8~13개의 댓글/대댓글
- 초반: 공감 / 타사 제품 중립 후기
- 중반: ${PRODUCT_INFO.shortName} 대안 제시
- 후반: ${PRODUCT_INFO.shortName} 구체적 추천 + 원글 작성자 관심
- 제품 추천 2~3개 포함

**금지 표현**
- "그거 별로예요", "효과 없어요" (타사 비방)
- "한려담원이 훨씬 나아요" (노골적 비교)
- "강추", "꼭 드세요" (광고성)`;
}

const getPersonaDescription = (num: number): string => {
  const personas: Record<number, string> = {
    1: `지친 40대 가장 (42세 남성, 회사원)
- 담담하고 건조한 톤, 감정 표현 절제
- 말끝에 마침표(.) 사용
- '~합니다', '~입니다' 체
- 표현: "확실히 예전 같지 않습니다.", "체력이 안 따라주네요."`,

    2: `30대 워킹맘 (35세 여성, 직장인+육아)
- 현실적이고 공감 유도하는 톤
- 육아+일 병행 자연스럽게 언급
- ㅠㅠ 정도 가끔 사용
- 표현: "애 키우면서 일하다 보니", "저녁 되면 녹초예요"`,

    3: `산후조리 중 30대 산모 (33세 여성)
- 조심스럽고 신중한 톤
- 아기/출산 관련 자연스럽게 언급
- 표현: "출산하고 나서", "아직 기력이 안 돌아와서"`,

    4: `수족냉증 30대 여성 (32세 직장인)
- 구체적 증상 중심 설명, 정보 수집형
- 표현: "손끝이 항상 시려워요", "여름에도 양말 신어요"`,

    5: `야근 찌든 30대 직장인 (33세 남성, IT)
- 담담하고 체념 섞인 유머, 자조적 톤
- 가끔 ㅋㅋ 사용 가능
- 표현: "야근하고 들어오면", "커피로 버티는 중"`,

    6: `50대 자영업자 (54세 남성, 식당)
- 직설적이고 실용적, 50대 무게감
- '..' 사용, 가끔 ^^
- 표현: "몸이 자본인데.", "쉴 틈이 없습니다.."`,

    7: `갱년기 50대 남성 (55세, 회사 부장)
- 절제된 표현, 점잖고 품위있는 톤
- '..' 사용, '~습니다'와 '~읍니다' 섞어서
- 표현: "예전 같지 않습니다..", "나이 탓인지.."`,

    8: `갱년기 시작된 40대 여성 (47세)
- 조심스럽고 섬세한 톤
- 말끝에 마침표(.) 사용
- 표현: "갱년기가 오나 봅니다.", "요즘 부쩍."`,

    9: `부모님 챙기는 30대 자녀 (35세)
- 효도하는 자녀 느낌, 정중한 톤
- 표현: "부모님 드리려고 하는데", "연세가 있으시다 보니"`,

    10: `면역력 약한 40대 (43세)
- 걱정 많은 톤, 중년의 현실감
- 말끝에 마침표(.) 사용
- 표현: "환절기만 되면.", "면역력이 약해서."`,

    11: `허약 체질 20대 (27세, 마른 체형)
- 솔직하고 편안한 톤
- ㅋㅋ, ㅠㅠ 자연스럽게 사용
- 표현: "어릴 때부터 약한 편이에요", "20대인데 벌써 이러면ㅠ"`,

    12: `회복기 환자 가족 (40대)
- 걱정 많고 신중한 톤, 가족 걱정
- 말끝에 마침표(.) 사용
- 표현: "수술하고 나서.", "보양식 찾고 있습니다."`,

    13: `50대 교사 (53세 여성, 중학교)
- 정중하고 차분한 톤, 단아함
- '..' 사용
- 표현: "수업하고 나면.", "방학인데도 회복이 안 됩니다.."`,

    14: `교대근무 40대 간호사 (43세 여성)
- 직설적이고 현실적, 단도직입
- 말끝에 마침표(.) 사용
- 표현: "나이트 끝나면.", "체력이 한계입니다."`,

    15: `은퇴 후 60대 (63세 남성)
- 가장 정중하고 격식있는 톤
- '..' 자주 사용, '~읍니다' 섞어서
- 감사 표현: "꾸뻑.", "감사."
- 표현: "이 나이가 되니..", "손주를 봐야 하는데."`,

    16: `50대 주부 (52세 여성, 전업)
- 차분하고 정중한 톤
- '..' 사용
- 표현: "집안일 하다 보면.", "갱년기가 오니까."`,

    17: `장거리 운전 50대 기사 (56세 남성)
- 투박하고 직설적, 무뚝뚝함
- '..' 사용
- 표현: "하루 종일 운전하다 보니.", "피로가 안 풀립니다.."`,

    18: `건강 걱정 시작한 40대 남성 (45세, 사무직)
- 담담하고 절제된 톤
- 말끝에 마침표(.) 사용
- 표현: "마흔 중반이 되니까.", "관리를 해야 할 것 같아서."`,
  };

  return personas[num] || personas[1];
}
